
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isHR() {
      return isSignedIn() && request.auth.token.role == 'hr';
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isCorrectEmployeeOnCreate(employeeId) {
      return request.resource.data.employeeId == employeeId;
    }

    function isEmployeeIdImmutable() {
      return request.resource.data.employeeId == resource.data.employeeId;
    }
    
    match /manualCorrections/{manualCorrectionId} {
      allow get, list, create: if isSignedIn();
      allow update, delete: if isHR();
    }
    
    match /schedules/{scheduleId} {
      allow get, list, create, update, delete: if isSignedIn();
    }

    match /employees/{employeeId} {
      allow get: if isHR() || isOwner(employeeId);
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isHR() || isSignedIn();
      allow delete: if isHR() && resource != null;
    }

    match /employees/{employeeId}/attendanceRecords/{attendanceRecordId} {
      allow get, list: if isHR() || isOwner(employeeId);
      allow create: if isHR() && isCorrectEmployeeOnCreate(employeeId);
      allow update: if isHR() && resource != null && isEmployeeIdImmutable();
      allow delete: if isHR() && resource != null;
    }

    match /employees/{employeeId}/payrollData/{payrollDataId} {
      allow get, list: if isHR() || isOwner(employeeId);
      allow create: if isHR() && isCorrectEmployeeOnCreate(employeeId);
      allow update: if isHR() && resource != null && isEmployeeIdImmutable();
      allow delete: if isHR() && resource != null;
    }

    match /employees/{employeeId}/payslips/{payslipId} {
      allow get, list: if isHR() || isOwner(employeeId);
      allow create, update, delete: if isHR();
    }

    match /employees/{employeeId}/absencePredictions/{absencePredictionId} {
      allow get, list: if isHR() || isOwner(employeeId);
      allow create: if isHR() && isCorrectEmployeeOnCreate(employeeId);
      allow update: if isHR() && resource != null && isEmployeeIdImmutable();
      allow delete: if isHR() && resource != null;
    }

    match /employees/{employeeId}/schedules/{employeeScheduleId} {
      allow get, list: if isHR() || isOwner(employeeId);
      allow create: if isHR() && isCorrectEmployeeOnCreate(employeeId);
      allow update: if isHR() && resource != null && isEmployeeIdImmutable();
      allow delete: if isHR() && resource != null;
    }

    match /shifts/{shiftId} {
      allow get, list: if isSignedIn();
      allow create: if isHR();
      allow update: if isHR() && resource != null;
      allow delete: if isHR() && resource != null;
    }

    match /attendanceLogs/{logId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isHR();
    }
    
    match /processedAttendance/{processedAttendanceId} {
      allow get, list: if isSignedIn();
      allow create: if isHR();
      allow update: if isHR() && resource != null;
      allow delete: if isHR() && resource != null;
    }
  }
}
